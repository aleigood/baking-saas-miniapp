<template>
	<view>
		<view class="page-content page-content-with-tabbar-fab no-horizontal-padding">
			<template v-if="dataStore.members.length > 0">
				<ListItem v-for="(member, index) in dataStore.members" :key="member.id"
					@click="navigateToDetail(member.id)" :bleed="true" :divider="index < dataStore.members.length - 1">
					<!-- [兼容性修复] 新增一个容器来包裹头像和主要信息，实现 flex 布局 -->
					<view class="list-item-with-avatar">
						<!-- [兼容性修复] 新增头像占位符 -->
						<view class="avatar-placeholder">
							{{ getAvatarInitial(member) }}
						</view>
						<view class="main-info">
							<view class="name">{{ member.name || member.phone }}</view>
							<view class="desc">加入于: {{ formatChineseDate(member.joinDate) }}</view>
						</view>
					</view>
					<view class="side-info">
						<view class="value">{{ getRoleName(member.role) }}</view>
					</view>
				</ListItem>
			</template>
			<view v-else class="empty-state">
				<text>暂无人员信息</text>
			</view>
		</view>

		<AppFab v-if="canInvite" @click="uiStore.openModal(MODAL_KEYS.INVITE)" />

	</view>
</template>

<script setup lang="ts">
	import { computed } from 'vue';
	import { onShow } from '@dcloudio/uni-app';
	import { useUserStore } from '@/store/user';
	import { useDataStore } from '@/store/data';
	import { useUiStore } from '@/store/ui';
	import { MODAL_KEYS } from '@/constants/modalKeys';
	import AppFab from '@/components/AppFab.vue';
	import ListItem from '@/components/ListItem.vue';
	import type { Member, Role } from '@/types/api';
	import { formatChineseDate } from '@/utils/format';

	const userStore = useUserStore();
	const dataStore = useDataStore();
	const uiStore = useUiStore();


	onShow(async () => {
		if (!dataStore.dataLoaded.members) {
			await dataStore.fetchMembersData();
		}
	});

	const currentUserRoleInTenant = computed(
		() => userStore.userInfo?.tenants.find(t => t.tenant.id === dataStore.currentTenantId)?.role
	);

	const canInvite = computed(() => {
		return currentUserRoleInTenant.value === 'OWNER' || currentUserRoleInTenant.value === 'ADMIN';
	});

	const getRoleName = (role : Role) => {
		const roleMap = {
			OWNER: '店主',
			ADMIN: '管理员',
			MEMBER: '员工',
			SUPER_ADMIN: '超级管理员'
		};
		return roleMap[role] || role;
	};

	/**
	 * [兼容性修复] 新增方法，用于获取成员姓名首字母作为头像
	 * @param member 成员对象
	 * @returns 返回姓名首字母，如果无姓名则返回'员'
	 */
	const getAvatarInitial = (member : Member) => {
		return member.name ? member.name[0] : '员';
	};

	const navigateToDetail = (memberId : string) => {
		uni.navigateTo({
			url: `/pages/personnel/detail?memberId=${memberId}`,
		});
	};
</script>

<style scoped lang="scss">
	@import '@/styles/common.scss';

	/* [兼容性修复] 引入 Mixin，将列表项内容的样式应用到当前页面作用域 */
	@include list-item-content-style;

	/* [兼容性修复] 新增头像相关样式 */
	.list-item-with-avatar {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.avatar-placeholder {
		width: 42px;
		height: 42px;
		border-radius: 50%;
		background-color: #f3e9e3;
		color: var(--primary-color);
		display: flex;
		justify-content: center;
		align-items: center;
		font-size: 16px;
		font-weight: 500;
		flex-shrink: 0;
	}
</style>